<script type="text/javascript" src="//cdn.ometria.com/tags/spreetesting.js"></script>
<script type="text/javascript">
    function getQueryVariable(haystack, needle) {
      var vars = haystack.split("&");
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        if (pair[0] == needle) {
          return pair[1];
        }
      }
      return(false);
    }

    if (ometria) {

      <% if controller_name == "home" %>
        ometria.init("homepage");
      <% elsif @product %>
        ometria.init("product",{
            "pid":"<%= @product.id %>"
        });
     <% elsif @taxon %>
        var result = {}
        result["category_id"] = "<%= @taxon.id %>"
        result["nitems"] = "<%= @products.count %>"
        result["page"] = "<%= params[:page] %>"

        var links = $('nav.pagination span.last a')
        if (links.length > 0) {
          var parser = document.createElement('a');
          parser.href = links.attr('href');
          var last_page = getQueryVariable(parser.search.substring(1), "page")
          if (last_page !== false) {
            result["npages"] = last_page;
          }
        }

        ometria.init("listing", result);
     <% elsif !params[:keywords].blank? %>
          ometria.init("listing",{
              "search": "<%= params[:keywords] %>",
              "nitems": "<%= @products.count %>",
              "page": "<%= params[:page] %>"
          })
     <% elsif controller_name == "orders" %>
        ometria.init("basket");
     <% elsif controller_name == "checkout" %>
        ometria.init("checkout")
        <% if params[:state] == "address" %>
          ometria.trackCheckout(1);
        <% elsif params[:state] == "delivery" %>
          ometria.trackCheckout(2);
        <% elsif params[:state] == "payment" %>
          ometria.trackCheckout(3);
        <% elsif params[:state] == "confirm" %>
          ometria.trackCheckout(4);
        <% end %>
     <% else %>
        ometria.init("<%= controller_name %>");
     <% end %>

    }
</script>
